import paho.mqtt.client as mqtt

# 1. è®¾ç½®è¦å»å“ªé‡Œå¬æ¶ˆæ¯
BROKER_ADDRESS = "20.205.107.61"  # è¿˜æ˜¯é‚£ä¸ªæœåŠ¡å™¨
TOPIC = "test/stm32"              # å¿…é¡»å’Œå‘é€ç«¯å®Œå…¨ä¸€è‡´ï¼

# 2. å®šä¹‰ã€è¿ä¸Šç½‘ã€‘ååšä»€ä¹ˆ
def on_connect(client, userdata, flags, rc):
    if rc == 0:
        print("âœ… [æ¥æ”¶ç«¯] å·²è¿æ¥åˆ°æœåŠ¡å™¨!")
        # ã€å…³é”®æ­¥éª¤ã€‘è¿ä¸Šåï¼Œç«‹åˆ»å»è®¢é˜…(Subscribe)è¯é¢˜
        # è¿™å°±åƒæ‰“ç”µè¯ç»™é‚®å±€ï¼šâ€œåªè¦æ˜¯ 'test/stm32' çš„ä¿¡ï¼Œéƒ½ç»™æˆ‘é€æ¥â€
        client.subscribe(TOPIC) 
    else:
        print(f"âŒ è¿æ¥å¤±è´¥ï¼Œé”™è¯¯ç : {rc}")

# 3. å®šä¹‰ã€æ”¶åˆ°ä¿¡ã€‘ååšä»€ä¹ˆ
# è¿™æ˜¯æ¥æ”¶ç«¯æœ€ç‹¬ç‰¹çš„å‡½æ•°ï¼Œä¸“é—¨å¤„ç†å‘æ¥çš„æ¶ˆæ¯
def on_message(client, userdata, msg):
    # msg.payload æ˜¯åŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œéœ€è¦ decode() è½¬æˆå­—ç¬¦ä¸²
    text = msg.payload.decode("utf-8")
    
    print(f"ğŸ“© [æ”¶åˆ°æ–°æ¶ˆæ¯]")
    print(f"   æ¥æºè¯é¢˜: {msg.topic}")
    print(f"   æ¶ˆæ¯å†…å®¹: {text}")
    print("-" * 30)

# 4. åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
client = mqtt.Client()

# 5. ç»‘å®šä¸¤ä¸ªâ€œå›è°ƒå‡½æ•°â€
# å‘Šè¯‰å®ƒè¿æ¥æˆåŠŸæ—¶å¹²å˜›
client.on_connect = on_connect 
# å‘Šè¯‰å®ƒæ”¶åˆ°æ¶ˆæ¯æ—¶å¹²å˜› (æŠŠä½ çš„å¤„ç†é€»è¾‘å­˜è¿›ç»“æ„ä½“)
client.on_message = on_message 

try:
    print(f"â³ [æ¥æ”¶ç«¯] æ­£åœ¨è¿æ¥æœåŠ¡å™¨å¹¶ç­‰å¾…æ¶ˆæ¯...")
    client.connect(BROKER_ADDRESS, 1883, 60)

    # 6. ã€æ­»å¾ªç¯ç­‰å¾…ã€‘
    # loop_forever æ˜¯ä¸“é—¨ç»™æ¥æ”¶ç«¯ç”¨çš„ã€‚
    # å®ƒä¼šå µå¡ä½ç¨‹åºï¼Œä¸€ç›´ä¿æŒè¿è¡Œï¼Œç›´åˆ°ä½ æŒ‰ Ctrl+C å¼ºè¡Œåœæ­¢ã€‚
    # å®ƒä¼šè‡ªåŠ¨å¤„ç†é‡è¿ã€å¿ƒè·³åŒ…å’Œæ¥æ”¶æ•°æ®ã€‚
    client.loop_forever()

except KeyboardInterrupt:
    print("\nğŸ›‘ ç”¨æˆ·æ‰‹åŠ¨åœæ­¢ç¨‹åº")
    client.disconnect()